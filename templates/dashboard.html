{% extends "layout.html" %}

{% block title %}Dashboard - SBD{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-0 mb-4">
            <h5>Filtros</h5>
            <form method="get">
                <div class="mb-3">
                    <label class="form-label small">Desde:</label>
                    <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ fecha_inicio }}">
                </div>
                <div class="mb-3">
                    <label class="form-label small">Hasta:</label>
                    <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ fecha_fin }}">
                </div>
                <div class="mb-3">
                    <label class="form-label small">Agrupar por:</label>
                    <select name="agrupar_por" class="form-select form-select-sm">
                        <option value="canal_venta" {% if agrupar_por == 'canal_venta' %}selected{% endif %}>Canal de Venta</option>
                        <option value="vendedor_distribuidor" {% if agrupar_por == 'vendedor_distribuidor' %}selected{% endif %}>Vendedor</option>
                        <option value="sku_sbd" {% if agrupar_por == 'sku_sbd' %}selected{% endif %}>SKU SBD</option>
                        <option value="codigo_cliente" {% if agrupar_por == 'codigo_cliente' %}selected{% endif %}>Código Cliente</option>
                        <option value="mes_anio" {% if agrupar_por == 'mes_anio' %}selected{% endif %}>Mes - Año</option>
                        <option value="fecha" {% if agrupar_por == 'fecha' %}selected{% endif %}>Día</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label small">Código Cliente:</label>
                    <input type="number" name="filtro_cliente" class="form-control form-control-sm" value="{{ filtro_cliente }}">
                </div>
                <button type="submit" class="btn btn-primary btn-sm w-100">Consultar</button>
            </form>
        </div>

        <div class="card p-3 shadow-sm border-danger border-0 mb-4">
            <h5 class="text-danger">Zona de Peligro</h5>
            <button class="btn btn-outline-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">Eliminar por Periodo</button>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card p-3 shadow-sm border-0 mb-4">
            <h5>Resumen de Ventas</h5>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Etiqueta</th>
                            <th>Unidades</th>
                            <th>Total Costo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in resumen %}
                        <tr>
                            <td>{{ row.etiqueta }}</td>
                            <td>{{ "{:,.0f}".format(row.total_cantidad) }}</td>
                            <td>${{ "{:,.2f}".format(row.total_monto) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-dark">
                        <tr>
                            <th>GRAN TOTAL</th>
                            <th>{{ "{:,.0f}".format(gran_total_cant) }}</th>
                            <th>${{ "{:,.2f}".format(gran_total_monto) }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="card p-3 shadow-sm border-0 mb-4">
            <h5>Últimos 10 Registros</h5>
            <div class="table-responsive small">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Fecha</th><th>SKU</th><th>Cliente</th><th>Costo</th></tr>
                    </thead>
                    <tbody>
                        {% for r in recent %}
                        <tr><td>{{ r.fecha }}</td><td>{{ r.sku_sbd }}</td><td>{{ r.codigo_cliente }}</td><td>${{ "{:,.2f}".format(r.total_venta_costo) }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('delete_records') }}" method="post">
                <div class="modal-header bg-danger text-white"><h5>¿Eliminar registros?</h5></div>
                <div class="modal-body">
                    <p>Se borrarán los datos según los filtros actuales:</p>
                    <ul>
                        <li><b>Desde:</b> {{ fecha_inicio }}</li>
                        <li><b>Hasta:</b> {{ fecha_fin }}</li>
                        <li><b>Cliente:</b> {{ filtro_cliente if filtro_cliente else 'Todos' }}</li>
                    </ul>
                    <input type="hidden" name="del_inicio" value="{{ fecha_inicio }}">
                    <input type="hidden" name="del_fin" value="{{ fecha_fin }}">
                    <input type="hidden" name="del_cliente" value="{{ filtro_cliente }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar permanentemente</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}